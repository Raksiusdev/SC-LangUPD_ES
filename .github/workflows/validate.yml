name: Validar Scripts BAT

on:
  pull_request:
    paths:
      - '**.bat'
  push:
    branches:
      - main
      - master
    paths:
      - '**.bat'
  workflow_dispatch:
    
jobs:
  validate-bat-files:
    runs-on: windows-latest
    name: Validaci√≥n de archivos .bat
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Listar archivos .bat modificados
        id: changed-files
        shell: powershell
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            $files = git diff --name-only $env:GITHUB_BASE_REF...HEAD | Where-Object { $_ -match '\.bat$' }
          } else {
            $files = git diff --name-only HEAD~1 HEAD | Where-Object { $_ -match '\.bat$' }
          }
          
          if ($files) {
            Write-Host "Archivos .bat encontrados:"
            $files | ForEach-Object { Write-Host "  - $_" }
            "found=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            $files -join "," | Out-File -FilePath bat_files.txt
          } else {
            Write-Host "No se encontraron archivos .bat modificados"
            "found=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Validar sintaxis de scripts
        if: steps.changed-files.outputs.found == 'true'
        shell: powershell
        run: |
          $hasErrors = $false
          
          if (Test-Path bat_files.txt) {
            $files = Get-Content bat_files.txt
            $files -split "," | ForEach-Object {
              $file = $_.Trim()
              if (Test-Path $file) {
                Write-Host "`n=== Validando: $file ===" -ForegroundColor Cyan
                
                # Verificar que el archivo existe y es legible
                $content = Get-Content $file -Raw -ErrorAction SilentlyContinue
                
                if ($null -eq $content) {
                  Write-Host "‚ùå ERROR: No se pudo leer el archivo" -ForegroundColor Red
                  $hasErrors = $true
                  return
                }
                
                # Verificar codificaci√≥n
                $encoding = [System.Text.Encoding]::Default.GetString([System.IO.File]::ReadAllBytes($file))
                if ($encoding -match '[^\x00-\x7F]') {
                  Write-Host "‚ö†Ô∏è  ADVERTENCIA: El archivo puede contener caracteres especiales" -ForegroundColor Yellow
                }
                
                # Validar estructura b√°sica de batch
                $lines = Get-Content $file
                $lineNum = 0
                
                foreach ($line in $lines) {
                  $lineNum++
                  
                  # Verificar sintaxis com√∫n de errores
                  if ($line -match '^\s*if\s+.*\(\s*$') {
                    Write-Host "‚ö†Ô∏è  L√≠nea $lineNum`: Posible par√©ntesis sin cerrar en IF" -ForegroundColor Yellow
                  }
                  
                  if ($line -match 'set\s+"[^"]*$') {
                    Write-Host "‚ö†Ô∏è  L√≠nea $lineNum`: Posible comilla sin cerrar en SET" -ForegroundColor Yellow
                  }
                  
                  if ($line -match '^::\s*$') {
                    Write-Host "‚ö†Ô∏è  L√≠nea $lineNum`: Etiqueta vac√≠a detectada" -ForegroundColor Yellow
                  }
                  
                  # Detectar comandos peligrosos
                  if ($line -match '\bformat\b|\bdel\s+/[fqs]\s+\*|\brd\s+/s\s+/q\s+c:\\') {
                    Write-Host "‚ùå L√≠nea $lineNum`: Comando potencialmente peligroso detectado" -ForegroundColor Red
                    $hasErrors = $true
                  }
                }
                
                Write-Host "‚úÖ Validaci√≥n sint√°ctica completada" -ForegroundColor Green
              }
            }
          }
          
          if ($hasErrors) {
            Write-Host "`n‚ùå Se encontraron errores cr√≠ticos en los scripts" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "`n‚úÖ Todos los scripts pasaron la validaci√≥n" -ForegroundColor Green
          }

      - name: Verificar variables cr√≠ticas
        if: steps.changed-files.outputs.found == 'true'
        shell: powershell
        run: |
          $hasIssues = $false
          
          if (Test-Path bat_files.txt) {
            $files = Get-Content bat_files.txt
            $files -split "," | ForEach-Object {
              $file = $_.Trim()
              if (Test-Path $file) {
                Write-Host "`n=== Verificando variables en: $file ===" -ForegroundColor Cyan
                
                $content = Get-Content $file -Raw
                
                # Verificar variables esenciales
                $requiredVars = @(
                  'GITHUB_OWNER',
                  'GITHUB_REPO',
                  'DEST_DIR'
                )
                
                foreach ($var in $requiredVars) {
                  if ($content -notmatch "set\s+`"$var=") {
                    Write-Host "‚ö†Ô∏è  Variable '$var' no encontrada o mal definida" -ForegroundColor Yellow
                    $hasIssues = $true
                  } else {
                    Write-Host "‚úÖ Variable '$var' encontrada" -ForegroundColor Green
                  }
                }
                
                # Verificar uso de rutas relativas peligrosas
                if ($content -match 'cd\s+\\\\|cd\s+/') {
                  Write-Host "‚ö†Ô∏è  Uso de rutas absolutas detectado - revisar compatibilidad" -ForegroundColor Yellow
                }
                
                # Verificar manejo de errores
                if ($content -notmatch 'ERRORLEVEL') {
                  Write-Host "‚ö†Ô∏è  No se detect√≥ manejo de errores (ERRORLEVEL)" -ForegroundColor Yellow
                }
              }
            }
          }
          
          if ($hasIssues) {
            Write-Host "`n‚ö†Ô∏è  Se encontraron advertencias - revisar antes de merge" -ForegroundColor Yellow
          }

      - name: Probar ejecuci√≥n simulada
        if: steps.changed-files.outputs.found == 'true'
        shell: powershell
        run: |
          Write-Host "`n=== Prueba de ejecuci√≥n simulada ===" -ForegroundColor Cyan
          
          if (Test-Path bat_files.txt) {
            $files = Get-Content bat_files.txt
            $files -split "," | ForEach-Object {
              $file = $_.Trim()
              if (Test-Path $file) {
                Write-Host "`nProbando: $file" -ForegroundColor Cyan
                
                # Crear un entorno simulado
                $env:USERPROFILE = $env:TEMP
                $env:SystemDrive = "C:"
                
                # Intentar parsear el script (sin ejecutarlo)
                try {
                  $content = Get-Content $file
                  Write-Host "‚úÖ Script parseado correctamente" -ForegroundColor Green
                } catch {
                  Write-Host "‚ùå Error al parsear el script: $_" -ForegroundColor Red
                  exit 1
                }
              }
            }
          }

      - name: Generar reporte
        if: always() && steps.changed-files.outputs.found == 'true'
        shell: powershell
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "         REPORTE DE VALIDACI√ìN" -ForegroundColor Cyan
          Write-Host "========================================`n" -ForegroundColor Cyan
          
          if (Test-Path bat_files.txt) {
            $files = Get-Content bat_files.txt
            Write-Host "Archivos analizados:" -ForegroundColor White
            $files -split "," | ForEach-Object {
              Write-Host "  ‚úì $_" -ForegroundColor Green
            }
          }
          
          Write-Host "`nValidaciones realizadas:" -ForegroundColor White
          Write-Host "  ‚úì Sintaxis b√°sica de batch" -ForegroundColor Green
          Write-Host "  ‚úì Variables cr√≠ticas" -ForegroundColor Green
          Write-Host "  ‚úì Comandos peligrosos" -ForegroundColor Green
          Write-Host "  ‚úì Estructura del script" -ForegroundColor Green
          
          Write-Host "`n‚úÖ Validaci√≥n completada" -ForegroundColor Green

      - name: Comentar en PR
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let files = [];
            if (fs.existsSync('bat_files.txt')) {
              files = fs.readFileSync('bat_files.txt', 'utf8').split(',').map(f => f.trim());
            }
            
            const comment = `## üîç Validaci√≥n de Scripts BAT
            
            Se han validado los siguientes archivos:
            ${files.map(f => `- \`${f}\``).join('\n')}
            
            ### ‚úÖ Validaciones realizadas:
            - Sintaxis b√°sica de batch
            - Variables cr√≠ticas (GITHUB_OWNER, GITHUB_REPO, DEST_DIR)
            - Detecci√≥n de comandos peligrosos
            - Estructura y formato del script
            - Manejo de errores
            
            **Resultado:** Los scripts han pasado las validaciones autom√°ticas.
            
            ‚ö†Ô∏è **Nota:** Esta validaci√≥n es autom√°tica. Se recomienda revisi√≥n manual antes del merge.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });